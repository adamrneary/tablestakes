<!DOCTYPE html>

<html>
<head>
  <title>events.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="column.html">
                column.coffee
              </a>
            
              
              <a class="source" href="events.html">
                events.coffee
              </a>
            
              
              <a class="source" href="render.html">
                render.coffee
              </a>
            
              
              <a class="source" href="tablestakes.html">
                tablestakes.coffee
              </a>
            
              
              <a class="source" href="utils.html">
                utils.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>events.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class="highlight"><pre>window.TableStakesLib = {} <span class="keyword">unless</span> window.TableStakesLib
<span class="class"><span class="keyword">class</span> <span class="title">window</span>.<span class="title">TableStakesLib</span>.<span class="title">Events</span></span>

  constructor: (options) -&gt;
    <span class="property">@core</span> = options.core</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>keydown editing cell</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>keydown: (node, d, column) -&gt;
    <span class="keyword">switch</span> d3.event.keyCode
      <span class="keyword">when</span> <span class="number">9</span>  <span class="keyword">then</span> <span class="property">@_handleTab</span>(node, d, column)
      <span class="keyword">when</span> <span class="number">38</span> <span class="keyword">then</span> <span class="property">@_handleUpDown</span>(node, d, column,<span class="literal">false</span>)
      <span class="keyword">when</span> <span class="number">40</span> <span class="keyword">then</span> <span class="property">@_handleUpDown</span>(node, d, column,<span class="literal">true</span>)
      <span class="keyword">when</span> <span class="number">13</span> <span class="keyword">then</span> <span class="property">@_handleEnter</span>(node, d, column)
      <span class="keyword">when</span> <span class="number">27</span> <span class="keyword">then</span> <span class="property">@_handleEscape</span>(node, d, column)</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>move active cell left or right</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>_handleTab: (node, d, column) -&gt;
    currentindex = <span class="property">@core</span>.utils.getCurrentColumnIndex d.activatedID</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>if shiftkey is not pressed, get next</p>

            </div>
            
            <div class="content"><div class="highlight"><pre><span class="keyword">if</span> d3.event.shiftKey <span class="keyword">is</span> <span class="literal">false</span>
      index = <span class="property">@core</span>.utils.findEditableColumn d,currentindex+<span class="number">1</span>,<span class="literal">true</span>
      <span class="keyword">if</span> index?
        <span class="property">@core</span>._makeInactive node
        d.activatedID = <span class="property">@core</span>.columns[index].id
      <span class="keyword">else</span>
        nextNode = <span class="property">@core</span>.utils.findNextNode d, <span class="property">@core</span>.nodes
        <span class="keyword">if</span> nextNode?
          index = <span class="property">@core</span>.utils.findEditableColumn nextNode,<span class="number">0</span>,<span class="literal">true</span>
          <span class="keyword">if</span> index?
            <span class="property">@core</span>._makeInactive node
            d.activatedID = <span class="literal">null</span>
            nextNode.activatedID = <span class="property">@core</span>.columns[index].id</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>if shiftkey is not pressed, get previous</p>

            </div>
            
            <div class="content"><div class="highlight"><pre><span class="keyword">else</span>
      index = <span class="property">@core</span>.utils.findEditableColumn d,currentindex-<span class="number">1</span>,<span class="literal">false</span>
      <span class="keyword">if</span> index?
        <span class="property">@core</span>._makeInactive node
        d.activatedID = <span class="property">@core</span>.columns[index].id
      <span class="keyword">else</span>
        prevNode = <span class="property">@core</span>.utils.findPrevNode d, <span class="property">@core</span>.nodes
        <span class="keyword">if</span> prevNode?
          start = <span class="property">@core</span>.columns.length-<span class="number">1</span>
          index = <span class="property">@core</span>.utils.findEditableColumn prevNode,start,<span class="literal">false</span>
          <span class="property">@core</span>._makeInactive node
          prevNode.activatedID = <span class="property">@core</span>.columns[index].id
          d.activatedID = <span class="literal">null</span>
    d3.event.preventDefault()
    d3.event.stopPropagation()
    <span class="property">@core</span>.update()</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>move active cell to next cell above</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>_handleUpDown: (node, d, column,isUp) -&gt;
    currentindex = <span class="property">@core</span>.utils.getCurrentColumnIndex d.activatedID
    nextNode = <span class="property">@core</span>.utils.findEditableCell d,column,isUp
    <span class="keyword">if</span> nextNode?
      nextNode.activatedID = <span class="property">@core</span>.columns[currentindex].id
      <span class="property">@core</span>._makeInactive node
      d.activatedID = <span class="literal">null</span>
    <span class="property">@core</span>.update()</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>record change and deactivate</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>_handleEnter: (node, d, column) -&gt;
    <span class="property">@blur</span>(node, d, column)</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>reset value and deactivate</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>_handleEscape: (node, d, column) -&gt;
    d3.select(node).node().value = d[d.activatedID]
    d.activatedID = <span class="literal">null</span>
    <span class="property">@core</span>.update()</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>record change and deactivate</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>blur: (node, d, column) -&gt;
    <span class="keyword">unless</span> <span class="property">@core</span>.table.isInRender
      val = d3.select(node).text()
      <span class="keyword">unless</span> val <span class="keyword">is</span> d[d.activatedID]
        <span class="property">@_applyChangedState</span>(d)
        column.onEdit(d.id, column.id, val) <span class="keyword">if</span> column.onEdit
      d.activatedID = <span class="literal">null</span>
      <span class="property">@core</span>.update()

  _applyChangedState: (d) -&gt;
    d.changedID ?= []
    <span class="keyword">if</span> d.changedID.indexOf(d.activatedID) <span class="keyword">is</span> -<span class="number">1</span>
      d.changedID.push d.activatedID

  dragStart: (tr, d) -&gt;
    <span class="property">@initPosition</span> = $(tr).position()
    <span class="property">@_makeRowDraggable</span>(tr)
    $(tr).css
      left: <span class="property">@initPosition</span>.left
      top: <span class="property">@initPosition</span>.top

  _makeRowDraggable: (tr) -&gt;
    self = @

    rowWidth = $(tr).width()
    cellWidths = _.map $(tr).find(<span class="string">'td'</span>), (td) -&gt; $(td).width()
    d3.select(tr).classed(<span class="string">'dragged'</span>, <span class="literal">true</span>)
    $(tr).width(rowWidth)
    _.each $(tr).find(<span class="string">'td'</span>), (td, i) -&gt; $(td).width(cellWidths[i])

    <span class="function"><span class="title">onMouseOver</span></span> = (d, i) -&gt;
      c = self.core
      self.destinationIndex = i
      isDestination = c.utils.ourFunctor(c.table.isDragDestination(), d)
      self.destination = (<span class="keyword">if</span> isDestination <span class="keyword">then</span> d <span class="keyword">else</span> <span class="literal">null</span>)
      <span class="keyword">if</span> isDestination
        d3.select(@).classed(self._draggableDestinationClass(), <span class="literal">true</span>)

    <span class="function"><span class="title">onMouseOut</span></span> = (d) -&gt;
      d3.select(@).classed(self._draggableDestinationClass(), <span class="literal">false</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>FIXME pointer-events: none; does not work in IE -&gt; needs a workaround</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>tableEl = <span class="property">@core</span>.table.el()
    d3.selectAll(tableEl + <span class="string">' tbody tr:not(.dragged)'</span>)
      .<span class="literal">on</span>(<span class="string">'mouseover'</span>, onMouseOver)
      .<span class="literal">on</span>(<span class="string">'mouseout'</span>, onMouseOut)

    <span class="keyword">if</span> <span class="property">@core</span>.table.dragMode() <span class="keyword">is</span> <span class="string">'reorder'</span>
      d3.selectAll(tableEl + <span class="string">' thead tr'</span>)
        .<span class="literal">on</span>(<span class="string">'mouseover'</span>, onMouseOver)
        .<span class="literal">on</span>(<span class="string">'mouseout'</span>, onMouseOut)

  _draggableDestinationClass: -&gt;
    dragMode = <span class="property">@core</span>.table.dragMode()
    <span class="keyword">if</span> dragMode?
      dragMode + <span class="string">'-draggable-destination'</span>
    <span class="keyword">else</span>
      <span class="string">''</span>

  dragMove: (tr, d, x, y) -&gt;
    $(tr).css
      left: <span class="property">@initPosition</span>.left + d3.event.x
      top: <span class="property">@initPosition</span>.top + d3.event.y

  dragEnd: (tr, d) -&gt;
    d3.select(tr).classed(<span class="string">'dragged'</span>, <span class="literal">false</span>)
    tableEl = <span class="property">@core</span>.table.el()
    d3.selectAll(tableEl + <span class="string">' tbody tr, '</span> + tableEl + <span class="string">' thead tr'</span>)
      .classed(<span class="property">@_draggableDestinationClass</span>(), <span class="literal">false</span>)
      .<span class="literal">on</span>(<span class="string">'mouseover'</span>, <span class="literal">null</span>)
      .<span class="literal">on</span>(<span class="string">'mouseout'</span>, <span class="literal">null</span>)

    <span class="keyword">if</span> <span class="property">@core</span>.table.onDrag
      onDrag = <span class="property">@core</span>.table.onDrag()
      <span class="keyword">switch</span> <span class="property">@core</span>.table.dragMode()
        <span class="keyword">when</span> <span class="string">'reorder'</span> <span class="keyword">then</span> onDrag(d, <span class="property">@destinationIndex</span>)
        <span class="keyword">when</span> <span class="string">'hierarchy'</span> <span class="keyword">then</span> onDrag(d, <span class="property">@destination</span>)

  resizeDrag: (node) -&gt;
    th = node.parentNode
    old_width_left = parseFloat(d3.select(th).style(<span class="string">"width"</span>))
    old_width_right = parseFloat(d3.select(th.nextSibling).style(<span class="string">"width"</span>))
    new_width_left = d3.event.x
    new_width_right = old_width_left + old_width_right - new_width_left

    notTooSmall = new_width_left &gt; <span class="property">@core</span>.table._minColumnWidth <span class="keyword">and</span>
      new_width_right &gt; <span class="property">@core</span>.table._minColumnWidth
    <span class="keyword">if</span> notTooSmall
      d3.select(th).attr(<span class="string">"width"</span>, new_width_left + <span class="string">"px"</span>)
      d3.select(th).style(<span class="string">"width"</span>, new_width_left + <span class="string">"px"</span>)
      d3.select(th.nextSibling).attr(<span class="string">"width"</span>, new_width_right + <span class="string">"px"</span>)
      d3.select(th.nextSibling).style(<span class="string">"width"</span>, new_width_right + <span class="string">"px"</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>change row if class editable</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>editableClick: (node, d, _, unshift) -&gt;
    <span class="keyword">unless</span> d3.select(node).classed(<span class="string">'active'</span>)
      <span class="property">@core</span>.utils.deactivateAll <span class="property">@core</span>.data[<span class="number">0</span>]
      d.activatedID = d3.select(d3.select(node).node()).attr(<span class="string">"meta-key"</span>)
      <span class="property">@core</span>.update()
      d3.event.stopPropagation()
      d3.event.preventDefault()</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>toggle nested</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>nestedClick: (node,d, _, unshift) -&gt;
    <span class="keyword">if</span> d3.event.shiftKey <span class="keyword">and</span> <span class="keyword">not</span> unshift</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Shift-click to toggle fold all children, instead of itself</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>self = @
      <span class="keyword">if</span> d.values
        d.values.forEach (node) -&gt;
          self.nestedClick(<span class="keyword">this</span>, node, <span class="number">0</span>, <span class="literal">true</span>) <span class="keyword">if</span> node.values <span class="keyword">or</span> node._values
    <span class="keyword">else</span>
      <span class="keyword">if</span> d.values
        d._values = d.values
        d.values = <span class="literal">null</span>
      <span class="keyword">else</span>
        d.values = d._values
        d._values = <span class="literal">null</span>
    <span class="property">@core</span>.update()
    d3.event.preventDefault()
    d3.event.stopPropagation()

  toggleBoolean: (node, d, _, unshift, column) -&gt;
    column.onEdit(d.id, column.id, <span class="keyword">not</span> d[column.id]) <span class="keyword">if</span> column.onEdit
    <span class="property">@core</span>.update()

  selectClick: (node, d, _, unshift, column) -&gt;
    val = d3.event.target.value
    <span class="keyword">unless</span> val <span class="keyword">is</span> d[column.id]
      column.onEdit(d.id, column.id, val) <span class="keyword">if</span> column.onEdit
    <span class="property">@core</span>.update()

  buttonClick: (node, d, _, unshift, column) -&gt;
    val = d3.event.target.value
    column.onClick(d.id, column.id, val) <span class="keyword">if</span> column.onClick
    <span class="property">@core</span>.update()</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
