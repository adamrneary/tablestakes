<!DOCTYPE html>

<html>
<head>
  <title>events.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="column.html">
                column.coffee
              </a>
            
              
              <a class="source" href="events.html">
                events.coffee
              </a>
            
              
              <a class="source" href="headrow.html">
                headrow.coffee
              </a>
            
              
              <a class="source" href="render.html">
                render.coffee
              </a>
            
              
              <a class="source" href="tablestakes.html">
                tablestakes.coffee
              </a>
            
              
              <a class="source" href="utils.html">
                utils.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>events.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>window.TableStakesLib = {} <span class="keyword">unless</span> window.TableStakesLib
<span class="class"><span class="keyword">class</span> <span class="title">window</span>.<span class="title">TableStakesLib</span>.<span class="title">Events</span></span>

  constructor: (options) -&gt;
    <span class="property">@core</span> = options.core</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>keydown editing cell</p>
<p>we want to intercept tab, up, down, enter, and escape for special handling</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  keydown: (node, d, column) -&gt;
    <span class="keyword">switch</span> d3.event.keyCode
      <span class="keyword">when</span> <span class="number">9</span>  <span class="keyword">then</span> <span class="property">@_handleTab</span>(node, d, column)
      <span class="keyword">when</span> <span class="number">38</span> <span class="keyword">then</span> <span class="property">@_handleUpDown</span>(node, d, column, <span class="literal">false</span>)
      <span class="keyword">when</span> <span class="number">40</span> <span class="keyword">then</span> <span class="property">@_handleUpDown</span>(node, d, column, <span class="literal">true</span>)
      <span class="keyword">when</span> <span class="number">13</span> <span class="keyword">then</span> <span class="property">@_handleEnter</span>(node, d, column)
      <span class="keyword">when</span> <span class="number">27</span> <span class="keyword">then</span> <span class="property">@_handleEscape</span>(node, d, column)</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>move active cell left or right, but only to an editable cell. if the cell
is the last in the row, start with the first cell in the next row. if the
cell is the last editable cell, go to the first editable cell. in any case,
a changed cell be exited should be treated the same as if the user had 
pressed enter (recording the change)</p>
<p>TODO: This function could probably use some DRYing, right?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _handleTab: (node, d, column) -&gt;
    currentindex = <span class="property">@core</span>.utils.getCurrentColumnIndex d.activatedID</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>if shiftkey is not pressed, get next</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> d3.event.shiftKey <span class="keyword">is</span> <span class="literal">false</span>
      index = <span class="property">@core</span>.utils.findEditableColumn d, currentindex + <span class="number">1</span>, <span class="literal">true</span>
      <span class="keyword">if</span> index?
        <span class="property">@core</span>._makeInactive node
        <span class="property">@blur</span>(node, d, column)
        d.activatedID = <span class="property">@core</span>.columns[index].id
      <span class="keyword">else</span>
        nextNode = <span class="property">@core</span>.utils.findNextNode d, <span class="property">@core</span>.nodes
        <span class="keyword">if</span> nextNode?
          index = <span class="property">@core</span>.utils.findEditableColumn nextNode, <span class="number">0</span>, <span class="literal">true</span>
          <span class="keyword">if</span> index?
            <span class="property">@core</span>._makeInactive node
            <span class="property">@blur</span>(node, d, column)
            d.activatedID = <span class="literal">null</span>
            nextNode.activatedID = <span class="property">@core</span>.columns[index].id</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>if shiftkey is not pressed, get previous</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">else</span>
      index = <span class="property">@core</span>.utils.findEditableColumn d, currentindex - <span class="number">1</span>, <span class="literal">false</span>
      <span class="keyword">if</span> index?
        <span class="property">@core</span>._makeInactive node
        <span class="property">@blur</span>(node, d, column)
        d.activatedID = <span class="property">@core</span>.columns[index].id
      <span class="keyword">else</span>
        prevNode = <span class="property">@core</span>.utils.findPrevNode d, <span class="property">@core</span>.nodes
        <span class="keyword">if</span> prevNode?
          start = <span class="property">@core</span>.columns.length-<span class="number">1</span>
          index = <span class="property">@core</span>.utils.findEditableColumn prevNode,start,<span class="literal">false</span>
          <span class="property">@core</span>._makeInactive node
          <span class="property">@blur</span>(node, d, column)
          prevNode.activatedID = <span class="property">@core</span>.columns[index].id
          d.activatedID = <span class="literal">null</span>
          
    d3.event.preventDefault()
    d3.event.stopPropagation()
    <span class="property">@core</span>.update()</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>move active cell to next cell above or below. if there is no editable cell
to move to, take no action.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _handleUpDown: (node, d, column, isUp) -&gt;
    currentindex = <span class="property">@core</span>.utils.getCurrentColumnIndex d.activatedID
    nextNode = <span class="property">@core</span>.utils.findEditableCell d, column, isUp
    <span class="keyword">if</span> nextNode?
      <span class="property">@blur</span>(node, d, column)
      nextNode.activatedID = <span class="property">@core</span>.columns[currentindex].id
      <span class="property">@core</span>._makeInactive node
      d.activatedID = <span class="literal">null</span>
    <span class="property">@core</span>.update()</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>record change and deactivate</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _handleEnter: (node, d, column) -&gt;
    <span class="property">@blur</span>(node, d, column)</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>reset value and deactivate</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _handleEscape: (node, d, column) -&gt;
    d3.select(node).node().value = d[d.activatedID]
    d.activatedID = <span class="literal">null</span>
    <span class="property">@core</span>.update()</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>record change and deactivate</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  blur: (node, d, column) -&gt;
    <span class="keyword">unless</span> <span class="property">@core</span>.table.isInRender
      val = d3.select(node).text()
      <span class="keyword">if</span> val <span class="keyword">isnt</span> d[column.id]
        d.changed = column.id
      <span class="keyword">unless</span> val <span class="keyword">is</span> d[d.activatedID]
        <span class="property">@_applyChangedState</span>(d)
        <span class="property">@_editHandler</span>(d, column, val)
      d.activatedID = <span class="literal">null</span>
      <span class="property">@core</span>.update()</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>TODO: Let&#39;s document this method, even if it seems obvious</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _applyChangedState: (d) -&gt;
    d.changedID ?= []
    <span class="keyword">if</span> d.changedID.indexOf(d.activatedID) <span class="keyword">is</span> -<span class="number">1</span>
      d.changedID.push d.activatedID</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>TODO: Let&#39;s document this method, even if it seems obvious</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  dragStart: (tr, d) -&gt;
    <span class="property">@initPosition</span> = $(tr).position()
    <span class="property">@_handleDraggedState</span>(tr)
    $(tr).css
      left: <span class="property">@initPosition</span>.left
      top: <span class="property">@initPosition</span>.top</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>take necessary actions for a row in the process of being dragged</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _handleDraggedState: (tr) -&gt;
    self = @</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>While a row is being dragged, we want to apply the &#39;dragged&#39; class, but as
soon as we do, the widths of the cells go crazy because they are no longer
in the source table.</p>
<p>To combat this, we record the overall width of the row and the widths of
its cells before applying the class. After we set the class, we apply those
widths, and the change is not seen by the user</p>

            </div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>record row and cell widths</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    rowWidth = $(tr).width()
    cellWidths = _.map $(tr).find(<span class="string">'td'</span>), (td) -&gt; $(td).width()</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>apply the dragged class</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    d3.select(tr).classed(<span class="string">'dragged'</span>, <span class="literal">true</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>set the row and cell widths</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    $(tr).width(rowWidth)
    _.each $(tr).find(<span class="string">'td'</span>), (td, i) -&gt; $(td).width(cellWidths[i])</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>At this stage, the user has a semi-opaque version of the row moving along
with the mouse. But we want to provide more feedback as the row is passed
over the other rows on the table, depending on whether the individual 
rows are in scope as drag destinations or if the drag mode is reorder.</p>

            </div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>define the behaviors</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="function"><span class="title">onMouseOver</span></span> = (d, i) -&gt;
      c = self.core
      self.destinationIndex = i
      isDestination = c.utils.ourFunctor(c.table.isDragDestination(), d)
      self.destination = (<span class="keyword">if</span> isDestination <span class="keyword">then</span> d <span class="keyword">else</span> <span class="literal">null</span>)
      <span class="keyword">if</span> isDestination
        d3.select(@).classed(self._draggableDestinationClass(), <span class="literal">true</span>)

    <span class="function"><span class="title">onMouseOut</span></span> = (d) -&gt;
      d3.select(@).classed(self._draggableDestinationClass(), <span class="literal">false</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>apply the behaviors</p>
<p>FIXME pointer-events: none; does not work in IE -&gt; needs a workaround</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    tableEl = <span class="property">@core</span>.table.el()
    d3.selectAll(tableEl + <span class="string">' tbody tr:not(.dragged)'</span>)
      .<span class="literal">on</span>(<span class="string">'mouseover'</span>, onMouseOver)
      .<span class="literal">on</span>(<span class="string">'mouseout'</span>, onMouseOut)

    <span class="keyword">if</span> <span class="property">@core</span>.table.dragMode() <span class="keyword">is</span> <span class="string">'reorder'</span>
      d3.selectAll(tableEl + <span class="string">' thead tr'</span>)
        .<span class="literal">on</span>(<span class="string">'mouseover'</span>, onMouseOver)
        .<span class="literal">on</span>(<span class="string">'mouseout'</span>, onMouseOut)</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>TODO: Let&#39;s document this method, even if it seems obvious</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _draggableDestinationClass: -&gt;
    dragMode = <span class="property">@core</span>.table.dragMode()
    <span class="keyword">if</span> dragMode?
       <span class="string">"<span class="subst">#{dragMode}</span>-draggable-destination"</span>
    <span class="keyword">else</span>
      <span class="string">''</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>dynamically update css during drag so that the user gets continuous 
feedback on row location in addition to their mouse</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  dragMove: (tr, d, x, y) -&gt;
    $(tr).css
      left: <span class="property">@initPosition</span>.left + d3.event.x
      top: <span class="property">@initPosition</span>.top + d3.event.y</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>scroll to position: [0; maxHeight]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    tbodyHeight = $(<span class="property">@core</span>.tableObject.select(<span class="string">'tbody'</span>).node())[<span class="number">0</span>].scrollHeight
    theadOffset = $(<span class="property">@core</span>.tableObject.select(<span class="string">'thead'</span>).node()).height()
    maxHeight = tbodyHeight - $(<span class="property">@core</span>.tableObject.select(<span class="string">'tbody'</span>).node()).height()
    ratio = maxHeight / $(<span class="property">@core</span>.tableObject.select(<span class="string">'tbody'</span>).node()).height() <span class="comment"># for more smooth scrolling</span>
    position = (<span class="property">@initPosition</span>.top + d3.event.y) * ratio - theadOffset
    position = maxHeight <span class="keyword">if</span> position &gt; maxHeight

    $(<span class="property">@core</span>.tableObject.select(<span class="string">'tbody'</span>).node()).scrollTop(position)</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>when the dragging is done, remove the classes applied on dragStart and fire
the appropriate onDrag handler</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  dragEnd: (tr, d) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>remove drag-related classes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    d3.select(tr).classed(<span class="string">'dragged'</span>, <span class="literal">false</span>)
    tableEl = <span class="property">@core</span>.table.el()
    d3.selectAll(<span class="string">"<span class="subst">#{tableEl}</span> tbody tr, <span class="subst">#{tableEl}</span> thead tr"</span>)
      .classed(<span class="property">@_draggableDestinationClass</span>(), <span class="literal">false</span>)
      .<span class="literal">on</span>(<span class="string">'mouseover'</span>, <span class="literal">null</span>)
      .<span class="literal">on</span>(<span class="string">'mouseout'</span>, <span class="literal">null</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>fire the appropriate onDrag handler</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> <span class="property">@core</span>.table.onDrag
      onDrag = <span class="property">@core</span>.table.onDrag()
      <span class="keyword">switch</span> <span class="property">@core</span>.table.dragMode()
        <span class="keyword">when</span> <span class="string">'reorder'</span> <span class="keyword">then</span> onDrag(d, <span class="property">@destinationIndex</span>)
        <span class="keyword">when</span> <span class="string">'hierarchy'</span> <span class="keyword">then</span> onDrag(d, <span class="property">@destination</span>)

  resizeDrag: (node) -&gt;
    th = node.parentNode.parentNode
    index = parseFloat(d3.select(th).attr(<span class="string">'ref'</span>))

    thead = th.parentNode.parentNode
    allTh = []</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>select all corresponding &lt;th&gt; of every head row</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.each thead.childNodes, (tr) -&gt;
      allTh.push tr.childNodes[index]

    <span class="keyword">if</span> d3.select(node).classed(<span class="string">"right"</span>)
      old_width_left = parseFloat(d3.select(th).style(<span class="string">"width"</span>))
      old_width_right = parseFloat(d3.select(th.nextSibling).style(<span class="string">"width"</span>))
      new_width_left = d3.event.x
      new_width_right = old_width_left + old_width_right - new_width_left
    <span class="keyword">else</span>
      old_width_left = parseFloat(d3.select(th.previousSibling).style(<span class="string">"width"</span>))
      old_width_right = parseFloat(d3.select(th).style(<span class="string">"width"</span>))
      new_width_right = old_width_right - d3.event.x
      new_width_left = old_width_left + old_width_right - new_width_right

    notTooSmall = new_width_left &gt; <span class="property">@core</span>.table._minColumnWidth <span class="keyword">and</span>
      new_width_right &gt; <span class="property">@core</span>.table._minColumnWidth

    <span class="keyword">if</span> notTooSmall
      _.each allTh, (th) -&gt;
        <span class="keyword">return</span> <span class="keyword">unless</span> th?

      <span class="keyword">if</span> d3.select(node).classed(<span class="string">"right"</span>)
        d3.select(th).attr(<span class="string">"width"</span>, new_width_left + <span class="string">"px"</span>)
        d3.select(th).style(<span class="string">"width"</span>, new_width_left + <span class="string">"px"</span>)
        d3.select(th.nextSibling).attr(<span class="string">"width"</span>, new_width_right + <span class="string">"px"</span>)
        d3.select(th.nextSibling).style(<span class="string">"width"</span>, new_width_right + <span class="string">"px"</span>)
      <span class="keyword">else</span>
        d3.select(th.previousSibling).attr(<span class="string">"width"</span>, new_width_left + <span class="string">"px"</span>)
        d3.select(th.previousSibling).style(<span class="string">"width"</span>, new_width_left + <span class="string">"px"</span>)
        d3.select(th).attr(<span class="string">"width"</span>, new_width_right + <span class="string">"px"</span>)
        d3.select(th).style(<span class="string">"width"</span>, new_width_right + <span class="string">"px"</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>change row if class editable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  editableClick: (node, d, _, unshift) -&gt;
    target = d3.event.target
    _node = d3.select(node)
    td = d3.select(node.parentNode)
    <span class="keyword">unless</span> td.classed(<span class="string">'active'</span>) <span class="keyword">or</span> $(target).<span class="keyword">is</span>(<span class="string">'a'</span>)
      <span class="property">@core</span>.utils.deactivateAll <span class="property">@core</span>.data[<span class="number">0</span>]
      d.activatedID = d3.select(node.parentNode).attr(<span class="string">"meta-key"</span>)
      <span class="property">@core</span>.update()
      d3.event.preventDefault()
    d3.event.stopPropagation()</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>toggle nested</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  nestedClick: (node,d, _, unshift) -&gt;
    target = d3.event.target
    <span class="keyword">unless</span> $(target).<span class="keyword">is</span>(<span class="string">'a'</span>) <span class="keyword">or</span> d3.select(target).classed(<span class="string">'active'</span>)
      <span class="keyword">if</span> d3.event.shiftKey <span class="keyword">and</span> <span class="keyword">not</span> unshift</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Shift-click to toggle fold all children, instead of itself</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        self = @
        <span class="keyword">if</span> d.values
          d.values.forEach (_node) -&gt;
            <span class="keyword">if</span> _node.values <span class="keyword">or</span> _node._values
              self.nestedClick(<span class="keyword">this</span>, _node, <span class="number">0</span>, <span class="literal">true</span>)
      <span class="keyword">else</span>
        <span class="keyword">if</span> d.values
          d._values = d.values
          d.values = <span class="literal">null</span>
        <span class="keyword">else</span>
          d.values = d._values
          d._values = <span class="literal">null</span>
      <span class="property">@core</span>.update()
      d3.event.preventDefault()
    d3.event.stopPropagation()

  toggleBoolean: (node, d, _, unshift, column) -&gt;
    <span class="property">@_editHandler</span>(d, column, <span class="keyword">not</span> d[column.id])
    <span class="property">@core</span>.update()

  selectClick: (node, d, _, unshift, column) -&gt;
    val = d3.event.target.value
    <span class="keyword">unless</span> val <span class="keyword">is</span> d[column.id]
      <span class="property">@_editHandler</span>(d, column, val)
    <span class="property">@core</span>.update()

  buttonClick: (node, d, _, unshift, column) -&gt;
    val = d3.event.target.value
    column.onClick(d.id, column.id, val) <span class="keyword">if</span> column.onClick
    <span class="property">@core</span>.update()

  toggleSort: (el,column)-&gt;
    column.asc = !column.asc</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>disable sort for all columns</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    d3.selectAll(<span class="string">'.sorted-desc'</span>).classed(<span class="string">'sorted-desc'</span>,<span class="literal">false</span>)
    d3.selectAll(<span class="string">'.sorted-asc'</span>).classed(<span class="string">'sorted-asc'</span>,<span class="literal">false</span>)
    d3.selectAll(<span class="string">'th'</span>).filter (d)-&gt;
      <span class="keyword">if</span> d.id <span class="keyword">isnt</span> column.id
        d.asc = <span class="literal">null</span>

    <span class="property">@core</span>.table.sort column.id, column.asc

  doubleTap: (self, a, b, c, column) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Pseudo double-click implementation
according to <a href="http://appcropolis.com/implementing-doubletap-on-iphones-and-ipads/">http://appcropolis.com/implementing-doubletap-on-iphones-and-ipads/</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    timeDelta = <span class="number">500</span> <span class="comment"># time in milliseconds</span></pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>measure time between 2 touchend events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    now = <span class="keyword">new</span> Date().getTime()
    self.lastTouch = <span class="keyword">if</span> _.isUndefined(self.lastTouch) <span class="keyword">then</span> now + <span class="number">1</span> <span class="keyword">else</span> self.lastTouch

    delta = now - self.lastTouch</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>trigger editable event for Cell</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> <span class="number">0</span> &lt; delta &lt; timeDelta
      <span class="property">@editableClick</span>(self, a, b, c, column)

    self.lastTouch = now

  _editHandler: (row, column, newValue) -&gt;
    <span class="function"><span class="title">parseInput</span></span> = (value) -&gt;
      <span class="keyword">return</span> value <span class="keyword">unless</span> _.isString(value)
      parsedValue = numeral().unformat(value)
      <span class="keyword">if</span> _.first(value) <span class="keyword">is</span> <span class="string">'$'</span> <span class="keyword">or</span> _.last(value) <span class="keyword">is</span> <span class="string">'%'</span>
        <span class="keyword">return</span> parsedValue

      <span class="keyword">if</span> parsedValue <span class="keyword">is</span> <span class="number">0</span> <span class="comment">#probably something went wrong</span>
        <span class="keyword">if</span> value <span class="keyword">is</span> <span class="string">'0'</span>
          parsedValue
        <span class="keyword">else</span>
          value
      <span class="keyword">else</span>
        parsedValue

    newValue = parseInput newValue</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Call onEdit if column is editable, but not contain &#39;timeSeries&#39; attr</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">unless</span> _.has(column, <span class="string">'timeSeries'</span>)
      <span class="keyword">return</span> column.onEdit(row.id, column.id, newValue) <span class="keyword">if</span> _.isFunction column.onEdit</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Call onEdit function without changing anything if timeFrame have 12 months</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> column.timeSeries.length &lt;= <span class="number">12</span>
      <span class="keyword">return</span> column.onEdit(row.id, column.id, newValue) <span class="keyword">if</span> _.isFunction column.onEdit</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Prepare array of Unix timestamps to call onEdit function.
parse columnId (which is have format [firstPeriod]-[lastPeriod])</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [begin, end] = column.id.split(<span class="string">'-'</span>)
    begin = <span class="keyword">if</span> _.isNaN(parseInt(begin)) <span class="keyword">then</span> <span class="literal">undefined</span> <span class="keyword">else</span> parseInt(begin)
    end = <span class="keyword">if</span> _.isNaN(parseInt(end)) <span class="keyword">then</span> <span class="literal">undefined</span> <span class="keyword">else</span> parseInt(end)
    <span class="keyword">return</span> <span class="keyword">unless</span> begin <span class="keyword">and</span> end</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Calculate &#39;grouper&#39; - length of groupped months</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    filteredPeriod = _.filter(column.timeSeries, (periodUnix) -&gt; begin &lt;= periodUnix &lt;= end)</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Calculate newValue. If string - pass to all months the same value
if Int - divided by &#39;grouper&#39;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> _.isNaN parseFloat(newValue)
      dividedValue = newValue
    <span class="keyword">else</span>
      dividedValue = parseFloat(newValue) / filteredPeriod.length

    _.each filteredPeriod, (periodUnix, i) -&gt;
      column.onEdit(row.id, periodUnix, dividedValue) <span class="keyword">if</span> _.isFunction column.onEdit
    <span class="keyword">return</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
