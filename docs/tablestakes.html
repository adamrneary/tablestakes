<!DOCTYPE html>

<html>
<head>
  <title>tablestakes.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="column.html">
                column.coffee
              </a>
            
              
              <a class="source" href="events.html">
                events.coffee
              </a>
            
              
              <a class="source" href="headrow.html">
                headrow.coffee
              </a>
            
              
              <a class="source" href="render.html">
                render.coffee
              </a>
            
              
              <a class="source" href="tablestakes.html">
                tablestakes.coffee
              </a>
            
              
              <a class="source" href="utils.html">
                utils.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>tablestakes.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="class"><span class="keyword">class</span> <span class="title">window</span>.<span class="title">TableStakes</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>internal table settings/variables</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  id : Math.floor(Math.random() * <span class="number">10000</span>)
  header : <span class="literal">true</span>
  noData : <span class="string">"No Data Available."</span>
  childIndent : <span class="number">20</span>
  tableClassName : <span class="string">"tablestakes"</span>
  gridData : []
  gridFilteredData : []
  tableObject : <span class="literal">null</span>
  isInRender : <span class="literal">false</span>
  filterCondition : []
  dispatch : d3.dispatch(
    <span class="string">"elementClick"</span>, <span class="string">"elementDblclick"</span>, <span class="string">"elementMouseover"</span>, <span class="string">"elementMouseout"</span>
  )</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>defaults</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _minColumnWidth: <span class="number">50</span>
  _columns: []
  _margin :
    top: <span class="number">0</span>
    right: <span class="number">0</span>
    bottom: <span class="number">0</span>
    left: <span class="number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h2>Constructor, getter, and setter methods</h2>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>  constructor: (options) -&gt;
    <span class="property">@core</span> = <span class="keyword">new</span> window.TableStakesLib.Core
    <span class="property">@utils</span> = <span class="keyword">new</span> window.TableStakesLib.Utils
      core: @</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>builds getter/setter methods (initialized with defaults)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="property">@_synthesize</span>
      el: <span class="literal">null</span>
      isDeletable: <span class="literal">false</span>
      onDelete: <span class="literal">null</span>
      isResizable: <span class="literal">true</span>
      isSortable: <span class="literal">false</span>
      dragMode: <span class="literal">null</span>
      isDraggable: <span class="literal">false</span>
      onDrag: <span class="literal">null</span>
      isDragDestination: <span class="literal">true</span>
      rowClasses: <span class="literal">null</span>
      filterZero: <span class="literal">false</span> <span class="comment"># timeSeries specific flag</span>
      sorted: <span class="literal">null</span>      <span class="comment"># timeSeries specific flag</span>

    <span class="property">@filterCondition</span> = d3.map([])
    <span class="keyword">if</span> options?
      <span class="keyword">for</span> key <span class="keyword">of</span> options
        <span class="property">@set</span> key, options[key]</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>builds getter/setter methods (initialized with defaults)</p>
<p>for example, if the hash includes {isSortable: false} then:
  1. you get @_isSortable as an internal variable
  2. you get @isSortable() as an external getter method
  3. you get @isSortable(true) as an external setter method</p>
<p>See <a href="http://bost.ocks.org/mike/chart">http://bost.ocks.org/mike/chart</a> for more details.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _synthesize: (hash) -&gt;
    _.each hash, (value, key) =&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>create and set the internal variable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      @[<span class="string">'_'</span> + key] = value</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>save the function so that it can be called below</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="function"><span class="title">func</span></span> = (key) =&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>create the getter/setter function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        @[key] = (val) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>get the internal value if it is not being set</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="keyword">return</span> @[<span class="string">'_'</span> + key] <span class="keyword">unless</span> val?</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>else set the variable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          @[<span class="string">'_'</span> + key] = val</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>return @ to make the method chainable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          @</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>call the method a first time to set the default</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      func(key)</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>DEPRECATED: Use methods built by _synthesize</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  get: (key) -&gt;
    @[key]</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>DEPRECATED: Use methods built by _synthesize</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  set: (key, value, options) -&gt;
    @[key] = (<span class="keyword">if</span> value? <span class="keyword">then</span> value <span class="keyword">else</span> <span class="literal">true</span>) <span class="keyword">if</span> key?
    @</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>DEPRECATED: Use methods built by _synthesize</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">is</span>: (key) -&gt;
    <span class="keyword">if</span> @[key] <span class="keyword">then</span> <span class="literal">true</span> <span class="keyword">else</span> <span class="literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Margins have a custom getter/setter because it builds the 4 sides into one
method just like css does</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  margin: (val) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>get _margin if it is not being set</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">return</span> <span class="property">@_margin</span> <span class="keyword">unless</span> val?</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>else set _margin</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">for</span> side <span class="keyword">in</span> [<span class="string">'top'</span>,<span class="string">'right'</span>,<span class="string">'bottom'</span>,<span class="string">'left'</span>]
      <span class="property">@_margin</span>[side] = val[side] <span class="keyword">unless</span> <span class="keyword">typeof</span> val[side] <span class="keyword">is</span> <span class="string">"undefined"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>return @ to make the method chainable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    @</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Set &#39;max-height&#39; attr for table wrapper element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  height: (height) -&gt;
    <span class="keyword">return</span> <span class="property">@_height</span> || <span class="literal">false</span> <span class="keyword">if</span> _.isUndefined(height)
    <span class="property">@_height</span> = height</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>return @ to make the method chainable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    @</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Set &#39;max-width&#39; attr for table wrapper element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  width: (width) -&gt;
    <span class="keyword">return</span> <span class="property">@_width</span> || <span class="literal">false</span> <span class="keyword">if</span> _.isUndefined(width)
    <span class="property">@_width</span> = width</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>return @ to make the method chainable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    @</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Set data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  data: (arr) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>get the internal value if it is not being set</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">return</span> <span class="property">@_data</span> || [] <span class="keyword">unless</span> arr?</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>create and set the internal variable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="property">@_data</span> = arr</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>extend data array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.each _.filter(<span class="property">@_columns</span>, (col) -&gt; col.type <span class="keyword">is</span> <span class="string">"total"</span>), (col) =&gt;
      <span class="property">@_extendToTotalColumn</span>(col)</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>return @ to make the method chainable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    @</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Columns have a custom getter/setter because of their inherent complexity</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  columns: (columnList) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>get _columns if they are not being set</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">return</span> <span class="property">@_columns</span> <span class="keyword">unless</span> columnList</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>clear @_columns and @_headrows because this method does not allow you
to incrementally add columns. the method is a full reset</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="property">@_columns</span> = []
    <span class="property">@_headRows</span> = <span class="literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>create a column for each in the list</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.each columnList, (column) =&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Time series columns have all sorts of magical complexity. 
TODO: The following trickery should be refactored into another method
because it isn&#39;t a simple part of the idea of setting columns</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> column.timeSeries</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>If there are 12 or fewer periods to display, we will display monthly
data with no grouping and aggregation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> column.timeSeries.length &lt;= <span class="number">12</span>
          <span class="keyword">for</span> item <span class="keyword">in</span> column.timeSeries</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>TODO: what is this below?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            _column = _.clone column
            _column._id = column.id
            _column.id =  item
            <span class="keyword">if</span> column.label?
              _column.label = <span class="keyword">if</span> <span class="keyword">typeof</span> column.label <span class="keyword">is</span> <span class="string">'function'</span>
              <span class="keyword">then</span> column.label item <span class="keyword">else</span> column.label
            <span class="keyword">else</span>
              _column.label = <span class="keyword">new</span> Date(item).toGMTString().split(<span class="string">' '</span>)[<span class="number">2</span>]
              _column.secondary = <span class="keyword">new</span> Date(item).getFullYear().toString()</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>create and push the column</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            c = <span class="keyword">new</span> window.TableStakesLib.Column(_column)
            <span class="property">@_columns</span>.push c</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Else if there are 36 or fewer periods to display, we will display 
quarterly data and aggregate</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">else</span> <span class="keyword">if</span> <span class="number">12</span> &lt; column.timeSeries.length &lt;= <span class="number">36</span>
          grouper = <span class="number">3</span>
          <span class="keyword">for</span> item, i <span class="keyword">in</span> column.timeSeries <span class="keyword">by</span> grouper
            grouppedItems = _.first(column.timeSeries.slice(i), grouper)
            _column = _.clone column
            _column._id = column.id
            _column.id = [_.first(grouppedItems),_.last(grouppedItems)].join <span class="string">'-'</span>
            <span class="keyword">if</span> grouppedItems.length &gt; <span class="number">1</span>
              _column.label = [
                <span class="keyword">new</span> Date(_.first(grouppedItems)).toGMTString().split(<span class="string">' '</span>)[<span class="number">2</span>],
                <span class="keyword">new</span> Date(_.last(grouppedItems)).toGMTString().split(<span class="string">' '</span>)[<span class="number">2</span>]
              ].join <span class="string">' - '</span>
            <span class="keyword">else</span>
              _column.label = <span class="keyword">new</span> Date(_.first(grouppedItems))
                .toGMTString()
                .split(<span class="string">' '</span>)[<span class="number">2</span>]
            _column.secondary = <span class="keyword">new</span> Date(_.last(grouppedItems))
              .getFullYear()
              .toString()
            _column.secondary = <span class="keyword">new</span> Date(_.first(grouppedItems))
              .getFullYear()
              .toString() <span class="keyword">if</span> i <span class="keyword">is</span> <span class="number">0</span>
            c = <span class="keyword">new</span> window.TableStakesLib.Column(_column)
            <span class="property">@_columns</span>.push c</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>If there are more than 36 columns to display, we will display annual 
data and aggregate.</p>
<p>TODO: We should probably explode gracefully if there are more than 
144 periods to display</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">else</span>
          grouper = <span class="number">12</span>
          <span class="keyword">for</span> item, i <span class="keyword">in</span> column.timeSeries <span class="keyword">by</span> grouper
            grouppedItems = _.first(column.timeSeries.slice(i), grouper)
            _column = _.clone column
            _column._id = column.id
            _column.id = [_.first(grouppedItems),_.last(grouppedItems)].join <span class="string">'-'</span>
            <span class="keyword">if</span> <span class="keyword">new</span> Date(_.first(grouppedItems)).getMonth() <span class="keyword">is</span> <span class="number">0</span>
              _column.label = <span class="string">"
              <span class="subst">#{ <span class="keyword">new</span> Date(_.first(grouppedItems)).getFullYear() }</span>"</span>
            <span class="keyword">else</span> <span class="keyword">if</span> grouppedItems.length &gt; <span class="number">1</span>
              _column.label = <span class="string">"
              <span class="subst">#{ <span class="keyword">new</span> Date(_.first(grouppedItems)).getMonth()+<span class="number">1</span> }</span>/
              <span class="subst">#{ <span class="keyword">new</span> Date(_.first(grouppedItems)).getFullYear() }</span> -
              <span class="subst">#{ <span class="keyword">new</span> Date(_.last(grouppedItems)).getMonth()+<span class="number">1</span> }</span>/
              <span class="subst">#{ <span class="keyword">new</span> Date(_.last(grouppedItems)).getFullYear() }</span>"</span>
            <span class="keyword">else</span>
              _column.label = <span class="string">"
              <span class="subst">#{ <span class="keyword">new</span> Date(_.first(grouppedItems)).getMonth()+<span class="number">1</span> }</span>/
              <span class="subst">#{ <span class="keyword">new</span> Date(_.first(grouppedItems)).getFullYear() }</span>"</span>

            c = <span class="keyword">new</span> window.TableStakesLib.Column(_column)
            <span class="property">@_columns</span>.push c</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>This &#39;else if&#39; is for columns that should calculate sum of all other
columns with id = column.related</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">else</span> <span class="keyword">if</span> column[<span class="string">"type"</span>] <span class="keyword">is</span> <span class="string">"total"</span>
        c = <span class="keyword">new</span> window.TableStakesLib.Column(column)
        <span class="property">@_columns</span>.push c

        <span class="property">@_extendToTotalColumn</span>(column)</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>This &#39;else&#39; is for columns that are not time series. It will get lost
less easily if the time series stuff is refactored to a new method</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">else</span>
        c = <span class="keyword">new</span> window.TableStakesLib.Column(column)
        c._id = c.id
        <span class="property">@_columns</span>.push c</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>return @ to make the method chainable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    @</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>TODO: this method needs a lot of documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  headRows: (filter) -&gt;
    <span class="keyword">return</span> <span class="property">@_headRows</span> <span class="keyword">unless</span> filter?</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Variable:
_headRows - local array of head rows
_columns - local array of columns
@_columns - global array of columns
@_headRows - global array of head rows</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="property">@_headRows</span> = []</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>if filter could be applied</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> _.filter(<span class="property">@_columns</span>, (col) -&gt; _.has(col, filter)).length &gt; <span class="number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>create new array of columns</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      _columns = []
      _.each <span class="property">@_columns</span>, (col) -&gt;
        c = _.clone col
        <span class="keyword">if</span> _.has(col, filter)
          c.label = col[filter]
        <span class="keyword">else</span>
          c.label = <span class="string">""</span>
        _columns.push c

      row = <span class="keyword">new</span> window.TableStakesLib.HeadRow(
        col: _columns
        headClasses: filter
      )
    <span class="keyword">else</span>
      <span class="property">@_headRows</span> = <span class="literal">null</span>
      <span class="keyword">return</span> @

    <span class="keyword">if</span> _.filter(<span class="property">@_columns</span>, (col) -&gt; _.has(col, <span class="string">'timeSeries'</span>)).length &gt; <span class="number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>special filtering rule for secondary timeSeries header</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      visiblePeriod = []
      _.each row.col, (column, i) -&gt;
        hidden = <span class="string">'hidden'</span>
        <span class="keyword">if</span> column.timeSeries
          <span class="keyword">if</span> _.isNumber column.id
            visiblePeriod.push column.id
          <span class="keyword">else</span> <span class="keyword">if</span> _.isString column.id
            begin = parseInt column.id.split(<span class="string">'-'</span>)[<span class="number">0</span>]
            end = parseInt column.id.split(<span class="string">'-'</span>)[<span class="number">1</span>]
            _.each column.timeSeries, (date) -&gt;
              visiblePeriod.push date <span class="keyword">if</span> begin &lt;= date &lt;= end

      _.each row.col, (column, i) -&gt;
        filtered = _.filter visiblePeriod, (date) -&gt;
          (<span class="keyword">new</span> Date date).getFullYear().toString() <span class="keyword">is</span> column.label
        first = _.first(filtered)
        first = _.first(visiblePeriod) <span class="keyword">unless</span> !!first
        <span class="keyword">if</span> _.isString(column.id)
          begin = parseInt column.id.split(<span class="string">'-'</span>)[<span class="number">0</span>]
          end = parseInt column.id.split(<span class="string">'-'</span>)[<span class="number">1</span>]
          <span class="keyword">unless</span> begin &lt;= first &lt;= end
            column.label = <span class="string">""</span>
        <span class="keyword">else</span> <span class="keyword">unless</span> column.id <span class="keyword">is</span> first
          column.label = <span class="string">""</span></pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>end if <em>.filter(@_columns, (col) -&gt; </em>.has(col, &#39;timeSeries&#39;)).length &gt; 0</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="property">@_headRows</span>.push row
    <span class="property">@_headRows</span>.push <span class="keyword">new</span> window.TableStakesLib.HeadRow(
      col: <span class="property">@_columns</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>return @ to make the method chainable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    @</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>TODO: this method needs a lot of documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  parseFlatData: (flatData, idKey) -&gt;
    data = []
    groupedById = _.groupBy(flatData, (obj) -&gt; obj[idKey])
    _.each _.keys(groupedById), (itemId, i) -&gt;
      item = {id: i}
      item[idKey] = itemId
      item[<span class="string">"period_id"</span>] = _.pluck(groupedById[itemId], <span class="string">"period_id"</span>)
      item[<span class="string">"period"</span>] = _.pluck(groupedById[itemId], <span class="string">"periodUnix"</span>)
      item[<span class="string">"dataValue"</span>] = _.pluck(groupedById[itemId], <span class="string">"actual"</span>)
      data.push item
    <span class="property">@data</span>(data)</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>return @ to make the method chainable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    @</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <h2>Render/update methods</h2>

            </div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>TODO: this method needs a lot of documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  render: -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Apply sorting to column</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    sortedColumn = _.find <span class="property">@columns</span>(), (col) -&gt;
      _.has(col, <span class="string">"sorted"</span>)
    <span class="property">@sorter</span>(sortedColumn) <span class="keyword">if</span> sortedColumn?

    <span class="property">@gridData</span> = [values: <span class="property">@data</span>()]
    <span class="property">@columns</span>().forEach (column, i) =&gt;
      <span class="property">@gridData</span>[<span class="number">0</span>][column[<span class="string">'id'</span>]] = column[<span class="string">'id'</span>]
    <span class="property">@setID</span> <span class="property">@gridData</span>[<span class="number">0</span>], <span class="string">"0"</span>
    <span class="property">@gridFilteredData</span> = <span class="property">@gridData</span>
    <span class="property">@_setFilter</span> <span class="property">@gridFilteredData</span>[<span class="number">0</span>], <span class="property">@filterCondition</span>
    wrap = d3.select(<span class="property">@el</span>())
      .html(<span class="string">''</span>)

    wrap.datum(<span class="property">@gridFilteredData</span>)
      .call( (selection) =&gt; <span class="property">@update</span> selection)</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>@dispatchManualEvent(d3.select(&#39;td&#39;).node())</p>

            </div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>return @ to make the method chainable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    @</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>TODO: this method needs a lot of documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  update: (selection) -&gt;
    selection.each (data) =&gt;
      <span class="property">@core</span>.set
        selection: selection
        table: @
        data: data
      <span class="property">@core</span>.render()

    <span class="property">@isInRender</span> = <span class="literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>return @ to make the method chainable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    @</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>TODO: this method needs a lot of documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  dispatchManualEvent: (target) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>all browsers except IE before version 9</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> target.dispatchEvent <span class="keyword">and</span> document.createEvent
      mousedownEvent = document.createEvent(<span class="string">"MouseEvent"</span>)
      mousedownEvent.initMouseEvent(
        <span class="string">"dblclick"</span>, <span class="literal">true</span>, <span class="literal">true</span>, window, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,
        <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="number">0</span>, <span class="literal">null</span>
      )
      target.dispatchEvent(mousedownEvent)
    <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>IE before version 9</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> document.createEventObject
        mousedownEvent = document.createEventObject(window.event)</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>left button is down</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        mousedownEvent.button = <span class="number">1</span>
        target.fireEvent(<span class="string">"dblclick"</span>, mousedownEvent)
    <span class="keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>TODO: this method needs a lot of documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setID : (node, prefix) -&gt;
    node[<span class="string">'_id'</span>] = prefix
    <span class="keyword">if</span> node.values
      node.values.forEach (subnode, i) =&gt;
        <span class="property">@setID</span> subnode, prefix+<span class="string">"_"</span>+i
    <span class="keyword">if</span> node._values
      node._values.forEach (subnode, i) =&gt;
        <span class="property">@setID</span> subnode, prefix+<span class="string">"_"</span>+i</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <h2>Simple sort and filter (not time series) methods</h2>

            </div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>TODO: this method needs a lot of documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  sort: (columnId, isAsc, returnData = <span class="literal">false</span>)-&gt;
    <span class="keyword">return</span> <span class="keyword">unless</span> columnId? <span class="keyword">or</span> isAsc
    <span class="function"><span class="title">sortFunction</span></span> = (a,b)-&gt;
      <span class="keyword">if</span> a[columnId]? <span class="keyword">and</span> b[columnId]?
        <span class="keyword">if</span> isAsc
          <span class="keyword">if</span> _.isNumber(a[columnId]) <span class="keyword">and</span> _.isNumber(b[columnId])
            a[columnId] - b[columnId]
          <span class="keyword">else</span>
            first = a[columnId].toString().toUpperCase()
            second = b[columnId].toString().toUpperCase()
            <span class="keyword">if</span> first &gt; second
              <span class="number">1</span>
            <span class="keyword">else</span>
              -<span class="number">1</span>
        <span class="keyword">else</span>
          <span class="keyword">if</span> _.isNumber(a[columnId]) <span class="keyword">and</span> _.isNumber(b[columnId])
            b[columnId] - a[columnId]
          <span class="keyword">else</span>
            first = a[columnId].toString().toUpperCase()
            second = b[columnId].toString().toUpperCase()
            <span class="keyword">if</span> first &lt; second
              <span class="number">1</span>
            <span class="keyword">else</span>
              -<span class="number">1</span>
      <span class="keyword">else</span>
        <span class="number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>TODO: make it recursive</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="function"><span class="title">sortRecursive</span></span> = (data) =&gt;
      _data = _.map data, (row) -&gt;
        <span class="keyword">if</span> row[<span class="string">'values'</span>]?
          row.values = sortRecursive(row.values)
        <span class="keyword">if</span> row[<span class="string">'_values'</span>]?
          row._values = sortRecursive(row._values)
        row
      _data.sort sortFunction
      _data

    _data = <span class="property">@data</span>()
    <span class="keyword">if</span> _.find(<span class="property">@data</span>(), (row) -&gt; (<span class="string">'values'</span> <span class="keyword">in</span> _.keys(row)) <span class="keyword">or</span> (<span class="string">'_values'</span> <span class="keyword">in</span> _.keys(row)))
      _data = sortRecursive(_data)
    <span class="keyword">else</span>
      _data.sort sortFunction

    <span class="keyword">return</span> _data <span class="keyword">if</span> returnData
    <span class="property">@_data</span> = _data
    <span class="property">@render</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>This method simply provides an external interface for the internal 
_setFilter function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  filter: (keys, value) -&gt;
    value = value <span class="keyword">or</span> <span class="string">''</span>
    value = value.toString().toUpperCase()
    keys = [keys] <span class="keyword">unless</span> _.isArray(keys)
    _.each keys, (key) =&gt;
      <span class="property">@filterCondition</span>.set key, value
    <span class="property">@_setFilter</span> <span class="property">@gridFilteredData</span>[<span class="number">0</span>], <span class="property">@filterCondition</span></pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>TODO: Should this be @update() ? It seems in other areas we use update,
which seems lighter. Not sure.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="property">@render</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>TODO: this method needs a lot of documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _setFilter: ( data, filter ) -&gt;
    self = <span class="keyword">this</span>
    data <span class="keyword">or</span>= []
    <span class="keyword">if</span> <span class="keyword">typeof</span> data._hiddenvalues == <span class="string">"undefined"</span>
      data[<span class="string">'_hiddenvalues'</span>] = []
    <span class="keyword">if</span> data.values
      data.values = data.values.concat(data._hiddenvalues)
      data._hiddenvalues = []
      <span class="keyword">for</span> i <span class="keyword">in</span> [data.values.length-<span class="number">1.</span><span class="number">.0</span>] <span class="keyword">by</span> -<span class="number">1</span>
        <span class="keyword">if</span> <span class="property">@_setFilter</span>(data.values[i], filter) == <span class="literal">null</span>
          data._hiddenvalues.push(data.values.splice(i, <span class="number">1</span>)[<span class="number">0</span>])
    <span class="keyword">if</span> data._values
      data._values = data._values.concat(data._hiddenvalues)
      data._hiddenvalues = []
      <span class="keyword">for</span> i <span class="keyword">in</span> [data._values.length-<span class="number">1.</span><span class="number">.0</span>] <span class="keyword">by</span> -<span class="number">1</span>
        <span class="keyword">if</span> <span class="property">@_setFilter</span>(data._values[i], filter) == <span class="literal">null</span>
          data._hiddenvalues.push(data._values.splice(i, <span class="number">1</span>)[<span class="number">0</span>])

    isDragDestination = <span class="property">@isDraggable</span>() <span class="keyword">and</span> <span class="property">@utils</span>.ourFunctor(<span class="property">@isDragDestination</span>(), data)
    <span class="keyword">if</span> (data.values <span class="keyword">and</span> data.values.length) <span class="keyword">or</span> isDragDestination
      <span class="keyword">return</span> data
    <span class="keyword">if</span> (data._values <span class="keyword">and</span> data._values.length) <span class="keyword">or</span> isDragDestination
      <span class="keyword">return</span> data

    matchFound = <span class="literal">true</span>
    <span class="keyword">for</span> key <span class="keyword">in</span> filter.keys()
      <span class="keyword">if</span> data[key]
        _data = data[key].toString().toUpperCase()
        <span class="keyword">if</span> _data.indexOf(filter.get(key)) == -<span class="number">1</span>
          matchFound = <span class="literal">false</span>
        <span class="keyword">else</span>
          matchFound = <span class="literal">true</span>
      <span class="keyword">else</span>
        matchFound = <span class="literal">false</span>
      <span class="keyword">break</span> <span class="keyword">if</span> matchFound
    <span class="keyword">if</span> matchFound
      <span class="keyword">return</span> data
    <span class="keyword">return</span> <span class="literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <h2>Time series methods</h2>

            </div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>This method defines how data will be aggregated in the event that a column
is time series and more than 12 periods are to be displayed.</p>
<p>For example, if you&#39;re looking at revenue figures:
    <em> Jan: 100
    </em> Feb: 200
    * Mar: 300</p>
<p>Aggregating using the &quot;sum&quot; method provides:
    * Jan-Mar: 600</p>
<p>However, if the figures were inventory figures (e.g. how many apples do I 
have at the end of each month?), you cannot add those figures. Because if 
you have:
    <em> Jan: 100 apples in stock
    </em> Feb: 200 apples in stock
    * Mar: 300 apples in stock</p>
<p>Aggregating using last would say:
    * Jan-Mar: 300 apples in stock (not 600!)</p>
<p>TODO: this method needs a lot of documentation
TODO: we could probably afford to refactor this into its own module and 
just use dataAggregate() as a getter/setter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  dataAggregate: (aggregator) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>Function of data aggregation:
1. sum
2. first/last
3. avarage                - future compatibility
4. max/min                - future compatibility
5. user defined function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    self = @
    aggregator = [aggregator] <span class="keyword">unless</span> _.isArray aggregator</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>Aggregator functions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="function"><span class="title">sum</span></span> = (data, availableTimeFrame) -&gt;
      _data = []

      <span class="keyword">if</span> availableTimeFrame.length &lt;= <span class="number">12</span>
        <span class="keyword">return</span> data
      <span class="keyword">else</span> <span class="keyword">if</span> <span class="number">12</span> &lt; availableTimeFrame.length &lt;= <span class="number">36</span>
        grouper = <span class="number">3</span>
      <span class="keyword">else</span>
        grouper = <span class="number">12</span>

      _.each data, (row, i) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <pre><code>   unless row.period? and row.period.length
     return</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>        _period = []
        _period_id = []
        _dataValue = []

        start = _.indexOf row.period, _.first availableTimeFrame
        end = _.indexOf row.period, _.last availableTimeFrame

        <span class="keyword">unless</span> start <span class="keyword">is</span> -<span class="number">1</span> <span class="keyword">or</span> end <span class="keyword">is</span> -<span class="number">1</span>
          _slicePeriod = <span class="keyword">if</span> row.period.length <span class="keyword">then</span> row.period.slice(start, end+<span class="number">1</span>) <span class="keyword">else</span> []
          _slicePeriodId = <span class="keyword">if</span> row.period_id <span class="keyword">and</span> row.period_id.length <span class="keyword">then</span> row.period_id.slice(start, end+<span class="number">1</span>) <span class="keyword">else</span> []
          _sliceValue = <span class="keyword">if</span> row.dataValue.length <span class="keyword">then</span> row.dataValue.slice(start, end+<span class="number">1</span>) <span class="keyword">else</span> []
          <span class="keyword">for</span> val, j <span class="keyword">in</span> _slicePeriod <span class="keyword">by</span> grouper
            _period.push [val,_.last(_slicePeriod.slice(j,j+grouper))].join <span class="string">'-'</span>
            _period_id.push [_.first(_slicePeriodId.slice(j,j+grouper)),_.last(_slicePeriodId.slice(j,j+grouper))].join <span class="string">'-'</span>
            _dataValue.push _.reduce(
              _sliceValue.slice(j, j+grouper),
            (memo, num) -&gt;
              <span class="keyword">if</span> _.isNumber(num) <span class="keyword">and</span> _.isNumber(memo)
                memo+num
              <span class="keyword">else</span>
                <span class="string">'-'</span>
            , <span class="number">0</span>
            )
        <span class="keyword">else</span>
          <span class="keyword">for</span> val, j <span class="keyword">in</span> availableTimeFrame <span class="keyword">by</span> grouper
            _period.push [val,_.last availableTimeFrame[j..j+grouper]].join <span class="string">'-'</span>
            _period_id.push [_.first(row.period_id.slice(j,j+grouper)),_.last(row.period_id.slice(j,j+grouper))].join <span class="string">'-'</span>
            _dataValue.push <span class="string">'-'</span>

        _row = _.clone(row)
        _row.period_id = _period_id
        _row.period = _period
        _row.dataValue = _dataValue

        <span class="keyword">if</span> _row[<span class="string">'values'</span>]?
          _row[<span class="string">'values'</span>] = sum(_row[<span class="string">'values'</span>], availableTimeFrame)
        <span class="keyword">else</span> <span class="keyword">if</span> _row[<span class="string">'_values'</span>]?
          _row[<span class="string">'_values'</span>] = sum(_row[<span class="string">'_values'</span>], availableTimeFrame)

        _data.push _row

      _data</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>TODO: this method needs a lot of documentation
TODO: we could probably afford to refactor this into a module with the 
rest of the aggregation stuff</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="function"><span class="title">first_last</span></span> = (flag, data, availableTimeFrame) -&gt;
      _data = []

      <span class="keyword">if</span> availableTimeFrame.length &lt;= <span class="number">12</span>
        <span class="keyword">return</span> data
      <span class="keyword">else</span> <span class="keyword">if</span> <span class="number">12</span> &lt; availableTimeFrame.length &lt;= <span class="number">36</span>
        grouper = <span class="number">3</span>
      <span class="keyword">else</span>
        grouper = <span class="number">12</span>

      _.each data, (row, i) -&gt;
        _period = []
        _period_id = []
        _dataValue = []

        start = _.indexOf row.period, _.first availableTimeFrame
        end = _.indexOf row.period, _.last availableTimeFrame

        <span class="keyword">unless</span> start <span class="keyword">is</span> -<span class="number">1</span> <span class="keyword">or</span> end <span class="keyword">is</span> -<span class="number">1</span>
          _slicePeriod = <span class="keyword">if</span> row.period.length <span class="keyword">then</span> row.period.slice(start, end+<span class="number">1</span>) <span class="keyword">else</span> []
          _slicePeriodId = <span class="keyword">if</span> row.period_id <span class="keyword">and</span> row.period_id.length <span class="keyword">then</span> row.period_id.slice(start, end+<span class="number">1</span>) <span class="keyword">else</span> []
          _sliceValue = <span class="keyword">if</span> row.dataValue.length <span class="keyword">then</span> row.dataValue.slice(start, end+<span class="number">1</span>) <span class="keyword">else</span> []

          <span class="keyword">for</span> val, j <span class="keyword">in</span> _slicePeriod <span class="keyword">by</span> grouper
            _period.push [val,_.last(_slicePeriod.slice(j,j+grouper))].join <span class="string">'-'</span>
            _period_id.push [_.first(_slicePeriodId.slice(j,j+grouper)),_.last(_slicePeriodId.slice(j,j+grouper))].join <span class="string">'-'</span>
            <span class="keyword">switch</span> flag
              <span class="keyword">when</span> <span class="string">'first'</span> <span class="keyword">then</span> _dataValue.push _.first _sliceValue.slice(j,j+grouper)
              <span class="keyword">when</span> <span class="string">'last'</span> <span class="keyword">then</span> _dataValue.push _.last _sliceValue.slice(j,j+grouper)
              <span class="keyword">else</span> _dataValue.push <span class="string">'-'</span>
        <span class="keyword">else</span>
          <span class="keyword">for</span> val, j <span class="keyword">in</span> availableTimeFrame <span class="keyword">by</span> grouper
            _period.push [val,_.last availableTimeFrame[j..j+grouper]].join <span class="string">'-'</span>
            _period_id.push [_.first(row.period_id.slice(j,j+grouper)),_.last(row.period_id.slice(j,j+grouper))].join <span class="string">'-'</span>
            _dataValue.push <span class="string">'-'</span>

        _row = _.clone(row)
        _row.period_id = _period_id
        _row.period = _period
        _row.dataValue = _dataValue

        <span class="keyword">if</span> _row[<span class="string">'values'</span>]?
          _row[<span class="string">'values'</span>] = first_last(_row[<span class="string">'values'</span>], availableTimeFrame)
        <span class="keyword">else</span> <span class="keyword">if</span> _row[<span class="string">'_values'</span>]?
          _row[<span class="string">'_values'</span>] = first_last(_row[<span class="string">'_values'</span>], availableTimeFrame)

        _data.push _row

      _data</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>End of Aggreagtor functions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    timeFrame = _.find(<span class="property">@_columns</span>, (obj) -&gt; obj.timeSeries?).timeSeries
    <span class="keyword">return</span> <span class="keyword">unless</span> timeFrame

    isZeroFilter = _.find(<span class="property">@_columns</span>, (col) =&gt; <span class="property">@utils</span>.ourFunctor(col.filterZero))?.filterZero
    <span class="property">@filterZeros</span>(<span class="property">@data</span>()) <span class="keyword">if</span> isZeroFilter

    data = <span class="property">@data</span>()

    _.each aggregator, (filter) -&gt;
      <span class="keyword">if</span> _.isFunction(filter)
        data = filter(data, timeFrame)
      <span class="keyword">else</span> <span class="keyword">if</span> filter <span class="keyword">is</span> <span class="string">'sum'</span>
        data = sum(data, timeFrame)
      <span class="keyword">else</span> <span class="keyword">if</span> filter <span class="keyword">is</span> <span class="string">'zero'</span>
        data = filterZero(data, timeFrame)
      <span class="keyword">else</span> <span class="keyword">if</span> filter <span class="keyword">in</span> [<span class="string">'first'</span>, <span class="string">'last'</span>]
        data = first_last(filter, data, timeFrame)

      self.data data</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>return @ to make the method chainable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    @</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>TODO: this method needs a lot of documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  filterZeros: (data) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>timeSeries specific function. return if no timeSeries &#39;columns&#39;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    cols = _.filter <span class="property">@_columns</span>, (col) -&gt; col.timeSeries?
    <span class="keyword">return</span> <span class="keyword">unless</span> cols.length

    availableTimeFrame = _.first(cols).timeSeries
    filteredData = data

    filteredData = _.filter filteredData, (row, i) -&gt;
      begin = _.indexOf row.period, _.first(availableTimeFrame)
      end = _.indexOf row.period, _.last(availableTimeFrame)
      <span class="keyword">if</span> begin &lt; <span class="number">0</span> <span class="keyword">or</span> end &lt; <span class="number">0</span> <span class="keyword">or</span> end &lt; begin
        <span class="keyword">return</span> <span class="literal">false</span>
      _.some(row.dataValue[begin..end], (val) -&gt; val)

    <span class="property">@data</span> filteredData</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>return @ to make the method chainable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    @</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>TODO: this method needs a lot of documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  sorter: (column) -&gt;
    <span class="keyword">return</span> @ <span class="keyword">unless</span> column? <span class="keyword">and</span> column.sorted

    <span class="keyword">unless</span> _.has(column, <span class="string">"timeSeries"</span>)
      <span class="property">@_data</span> = <span class="property">@sort</span>(column.id, column.sorted <span class="keyword">is</span> <span class="string">"asc"</span>, <span class="literal">true</span>)
    <span class="keyword">else</span>
      timeRange = column.timeSeries
      <span class="property">@_data</span> = _.sortBy <span class="property">@_data</span>, (row) -&gt;
        sum = <span class="number">0</span>
        <span class="keyword">if</span> timeRange.length &gt; <span class="number">12</span>
          sum =  _.reduce row.dataValue, ((memo, value) -&gt;
            memo + value
          ), <span class="number">0</span>
        <span class="keyword">else</span>
          sum = _.reduce timeRange, ((memo, timeStamp) -&gt;
            index = row.period.indexOf(timeStamp)

            <span class="keyword">unless</span> index <span class="keyword">is</span> -<span class="number">1</span>
              value = row.dataValue[index]
            <span class="keyword">else</span>
              value = <span class="number">0</span>
            memo + value
          ), <span class="number">0</span>
        sum *= -<span class="number">1</span> <span class="keyword">unless</span> column.sorted <span class="keyword">is</span> <span class="string">"asc"</span>
        <span class="keyword">return</span> sum</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>return @ to make the method chainable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    @</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>Add one more item (cell / column) to every row as sum of all related columns</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _extendToTotalColumn: (column) -&gt;
    <span class="keyword">return</span> @ <span class="keyword">unless</span> column?
    <span class="keyword">return</span> @ <span class="keyword">unless</span> <span class="property">@_columns</span>

    data = <span class="property">@data</span>()
    <span class="keyword">return</span> @ <span class="keyword">unless</span> data.length

    column.related = [column.related] <span class="keyword">unless</span> _.isArray column.related
    relatedColumns = []
    <span class="keyword">for</span> pointer <span class="keyword">in</span> column.related
      relatedColumn = _.find <span class="property">@_columns</span>, (col) -&gt; col._id <span class="keyword">is</span> pointer
      <span class="keyword">continue</span> <span class="keyword">unless</span> relatedColumn?
      relatedColumns.push relatedColumn
    <span class="keyword">return</span> @ <span class="keyword">unless</span> relatedColumns.length</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>we should care about only 1 example for each total column</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    data = _.map data, (row) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>exclude &quot;total column&quot; from row</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      row = _.omit row, column.id

    <span class="keyword">for</span> relatedColumn <span class="keyword">in</span> relatedColumns
      <span class="keyword">if</span> relatedColumn[<span class="string">"timeSeries"</span>]?

        timeRange = relatedColumn.timeSeries
        <span class="keyword">if</span> timeRange.length <span class="keyword">in</span> [<span class="number">0</span>, <span class="number">1</span>]
          <span class="property">@_columns</span> = (_.filter <span class="property">@_columns</span>, (col) -&gt; col.id <span class="keyword">isnt</span> column.id) <span class="keyword">if</span> relatedColumns.length <span class="keyword">is</span> <span class="number">1</span>
          <span class="keyword">continue</span>

        _.each data, (row) -&gt;
          <span class="keyword">if</span> timeRange.length &gt; <span class="number">12</span>
            row[column.id] = (row[column.id] || <span class="number">0</span>) + _.reduce row.dataValue, ((memo, value) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>prevent adding NaN, undefined, null and so on...</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              memo + (value || <span class="number">0</span>)
            ), <span class="number">0</span>
          <span class="keyword">else</span>
            row[column.id] = (row[column.id] || <span class="number">0</span>) + _.reduce timeRange, ((memo, timeStamp) -&gt;
              index = row.period.indexOf(timeStamp)

              <span class="keyword">unless</span> index <span class="keyword">is</span> -<span class="number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>prevent adding NaN, undefined, null and so on...</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                value = row.dataValue[index] || <span class="number">0</span>
              <span class="keyword">else</span>
                value = <span class="number">0</span>
              memo + value
            ), <span class="number">0</span>

      <span class="keyword">else</span> <span class="keyword">if</span> relatedColumns.length &gt; <span class="number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>prevent adding NaN, undefined, null and so on...</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        row[column.id] = (row[column.id] || <span class="number">0</span>) + (row[relatedColumn.id] || <span class="number">0</span>)
      <span class="keyword">else</span>
        <span class="property">@_columns</span> = _.filter <span class="property">@_columns</span>, (col) -&gt; col.id <span class="keyword">isnt</span> column.id

    <span class="property">@_data</span> = data</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>return @ to make the method chainable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    @</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
